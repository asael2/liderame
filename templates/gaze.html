<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis de Mirada - Liderame</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Open Sans', Arial, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2c5f8d 0%, #3a7ca5 100%);
            color: white;
            padding: 25px 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
        }

        .back-link {
            display: inline-block;
            color: white;
            text-decoration: none;
            margin-bottom: 12px;
            opacity: 0.9;
            font-weight: 500;
            font-size: 0.95em;
        }

        .back-link:hover {
            opacity: 1;
            text-decoration: underline;
        }

        .header h1 {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 6px;
            font-family: 'Roboto', sans-serif;
        }

        .header p {
            opacity: 0.92;
            font-weight: 300;
            font-size: 1.05em;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 30px;
        }

        /* Video Section Centrado */
        .video-section {
            max-width: 900px;
            margin: 0 auto 30px;
            text-align: center;
        }

        .video-section h2 {
            color: #2c5f8d;
            font-size: 1.8em;
            margin-bottom: 20px;
            font-weight: 600;
            font-family: 'Roboto', sans-serif;
        }

        #webcam-container {
            position: relative;
            width: 800px;
            max-width: 90vw;
            height: 600px;
            max-height: 70vh;
            margin: 0 auto;
            border-radius: 12px;
            background: #000;
            box-shadow: 0 10px 50px rgba(0,0,0,0.2);
            overflow: hidden;
            border: 4px solid rgba(44, 95, 141, 0.2);
        }

        .gaze-dot {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(92, 184, 92, 0.9) 0%, rgba(92, 184, 92, 0.4) 70%);
            border: 3px solid rgba(255, 255, 255, 0.95);
            box-shadow: 0 0 20px rgba(92, 184, 92, 0.9), 0 0 40px rgba(92, 184, 92, 0.5);
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -50%);
            transition: all 0.08s ease-out;
            display: none;
        }

        .gaze-dot:after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 5px rgba(255,255,255,0.8);
        }


        /* PNL Grid */
        .pnl-grid-container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e8e8e8;
        }

        .pnl-grid-container h2 {
            color: #2c5f8d;
            font-size: 1.5em;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
            font-family: 'Roboto', sans-serif;
        }

        .pnl-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            max-width: 750px;
            margin: 0 auto;
            position: relative;
        }

        .pnl-box {
            padding: 22px 15px;
            border-radius: 6px;
            text-align: center;
            font-size: 0.88em;
            font-weight: 500;
            min-height: 95px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: all 0.3s;
            border: 2px solid transparent;
            cursor: default;
        }

        .pnl-box.active {
            transform: scale(1.08);
            border-color: #2c5f8d;
            box-shadow: 0 5px 20px rgba(44, 95, 141, 0.25);
            font-weight: 700;
        }

        .pnl-box.construc-visual { background: #e8f4f8; color: #2c5f8d; }
        .pnl-box.memoria-visual { background: #fff9e6; color: #d9821b; }
        .pnl-box.construc-audio { background: #f3e8f5; color: #7b4397; }
        .pnl-box.memoria-audio { background: #e8f5e9; color: #4caf50; }
        .pnl-box.dialogo-interno { background: #fce8f3; color: #c2185b; }
        .pnl-box.sensaciones { background: #fff8e1; color: #f57c00; }
        .pnl-box.center { background: #f5f5f5; color: #999; font-size: 1.8em; border: 2px solid #ddd; }

        .pnl-box small {
            display: block;
            margin-top: 5px;
            font-size: 0.85em;
            opacity: 0.85;
        }

        /* Controls */
        .controls {
            background: white;
            border-radius: 8px;
            padding: 25px 30px;
            margin-top: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e8e8e8;
            text-align: center;
        }

        .btn {
            padding: 12px 30px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.3s;
            display: inline-block;
            border: none;
            cursor: pointer;
            margin: 0 8px;
        }

        .btn-calibrate {
            background: #5cb85c;
            color: white;
        }

        .btn-calibrate:hover {
            background: #4cae4c;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(92, 184, 92, 0.3);
        }

        .btn-back {
            background: #2c5f8d;
            color: white;
        }

        .btn-back:hover {
            background: #1e4d7b;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(44, 95, 141, 0.3);
        }

        .btn-toggle {
            background: #f0ad4e;
            color: white;
        }

        .btn-toggle:hover {
            background: #ec971f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(240, 173, 78, 0.3);
        }

        /* Status Message */
        .status-message {
            text-align: center;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
        }

        .status-message.active { display: block; }
        .status-message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-message.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        /* Footer */
        .footer {
            background: #2c5f8d;
            color: white;
            padding: 25px 30px;
            text-align: center;
            margin-top: 40px;
        }

        .footer p {
            opacity: 0.9;
            font-weight: 300;
            font-size: 0.95em;
        }

        /* Ocultar elementos de WebGazer que no necesitamos */
        #webgazerGazeDot {
            display: none !important;
        }
        
        #webgazerVideoFeed {
            width: 100% !important;
            height: auto !important;
            display: block !important;
            border-radius: 12px !important;
        }
        
        #webgazerFaceOverlay {
            display: block !important;
            width: 100% !important;
            height: auto !important;
        }
        
        #webgazerFaceFeedbackBox {
            display: none !important;
        }
        
        /* Ocultar contenedor de WebGazer por defecto (se mueve al contenedor) */
        body > video,
        body > canvas {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 20px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .pnl-grid {
                grid-template-columns: 1fr;
            }

            .btn {
                display: block;
                width: 100%;
                margin: 8px 0;
            }

            .video-section, .stats-panel, .pnl-grid-container, .controls {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="/" class="back-link">← Volver al inicio</a>
            <h1>Análisis de Patrones Oculares</h1>
            <p>Detección en tiempo real usando WebGazer.js (Frontend)</p>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Status Message -->
        <div id="statusMessage" class="status-message"></div>

        <!-- Video Centrado -->
        <div class="video-section">
            <h2>Análisis en Tiempo Real</h2>
            <div id="webcam-container">
                <!-- WebGazer insertará el video aquí -->
                <!-- Punto de mirada verde -->
                <div class="gaze-dot" id="gazeDot"></div>
            </div>
            <!-- Stats inline debajo del video -->
            <div style="display: flex; gap: 30px; justify-content: center; margin-top: 20px; flex-wrap: wrap;">
                <div style="text-align: center;">
                    <div style="color: #777; font-size: 0.85em; margin-bottom: 5px;">Estado Actual</div>
                    <div id="currentState" style="color: #5cb85c; font-size: 1.4em; font-weight: 600;">Inicializando...</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: #777; font-size: 0.85em; margin-bottom: 5px;">Dirección</div>
                    <div id="gazeDirection" style="color: #2c5f8d; font-size: 1.2em; font-weight: 600;">---</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: #777; font-size: 0.85em; margin-bottom: 5px;">Precisión</div>
                    <div id="accuracy" style="color: #2c5f8d; font-size: 1.2em; font-weight: 600;">Calibrando...</div>
                </div>
            </div>
        </div>

        <!-- PNL Pattern Grid -->
        <div class="pnl-grid-container">
            <h2>Mapa de Patrones Cognitivos (PNL)</h2>
            <div class="pnl-grid" id="pnl-grid">
                <div class="pnl-box construc-visual" data-state="construc_visual">
                    <strong>⬉ Construcción Visual</strong>
                    <small>Inventar/Imaginar</small>
                </div>
                <div class="pnl-box" style="background: transparent; border: none;"></div>
                <div class="pnl-box memoria-visual" data-state="memoria_visual">
                    <strong>⬈ Memoria Visual</strong>
                    <small>Recordar imágenes</small>
                </div>
                
                <div class="pnl-box construc-audio" data-state="construc_audio">
                    <strong>⬅ Construcción Auditiva</strong>
                    <small>Crear sonidos</small>
                </div>
                <div class="pnl-box center" data-state="centro">●</div>
                <div class="pnl-box memoria-audio" data-state="memoria_audio">
                    <strong>➡ Memoria Auditiva</strong>
                    <small>Recordar sonidos</small>
                </div>
                
                <div class="pnl-box dialogo-interno" data-state="dialogo_interno">
                    <strong>⬋ Diálogo Interno</strong>
                    <small>Auto-conversación</small>
                </div>
                <div class="pnl-box" style="background: transparent; border: none;"></div>
                <div class="pnl-box sensaciones" data-state="sensaciones">
                    <strong>⬊ Sensaciones</strong>
                    <small>Emociones/Sentir</small>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <a href="/calibrate" class="btn btn-calibrate">🎯 Calibrar Sistema</a>
            <button class="btn btn-toggle" onclick="toggleGazeDot()">👁️ Mostrar/Ocultar Punto</button>
            <a href="/" class="btn btn-back">← Volver al Inicio</a>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2025 Liderame - Sistema de Análisis de Patrones Oculares</p>
        </div>
    </footer>

    <script>
        let isWebGazerReady = false;
        let currentState = 'centro';
        let showGazeDot = true;
        let gazeHistory = [];
        const HISTORY_SIZE = 10;

        // Configuración de áreas de la pantalla para PNL
        const SCREEN_ZONES = {
            left_threshold: 0.33,
            right_threshold: 0.67,
            top_threshold: 0.33,
            bottom_threshold: 0.67
        };

        // Inicializar WebGazer
        async function initWebGazer() {
            try {
                showMessage('Iniciando detección de mirada...', 'info');
                
                webgazer.params.showVideoPreview = true;
                webgazer.params.showFaceOverlay = true;
                webgazer.params.showFaceFeedbackBox = true;
                
                await webgazer.setGazeListener(function(data, elapsedTime) {
                    if (data == null) return;
                    
                    const x = data.x;
                    const y = data.y;
                    
                    // Actualizar punto de mirada
                    updateGazeDot(x, y);
                    
                    // Guardar en historial
                    gazeHistory.push({x, y, time: Date.now()});
                    if (gazeHistory.length > HISTORY_SIZE) {
                        gazeHistory.shift();
                    }
                    
                    // Calcular zona basada en posición promedio
                    if (gazeHistory.length >= 5) {
                        const avgX = gazeHistory.reduce((sum, p) => sum + p.x, 0) / gazeHistory.length;
                        const avgY = gazeHistory.reduce((sum, p) => sum + p.y, 0) / gazeHistory.length;
                        
                        const zone = detectZone(avgX, avgY);
                        updatePNLState(zone);
                    }
                    
                }).begin();
                
                webgazer.showVideoPreview(true)
                    .showPredictionPoints(false)
                    .showFaceOverlay(true)
                    .showFaceFeedbackBox(false)
                    .applyKalmanFilter(true);
                
                // Mover el video y overlay al contenedor
                setTimeout(() => {
                    const video = document.getElementById('webgazerVideoFeed');
                    const overlay = document.getElementById('webgazerFaceOverlay');
                    const container = document.getElementById('webcam-container');
                    
                    // Limpiar contenedor primero
                    if (container) {
                        container.innerHTML = '<div class="gaze-dot" id="gazeDot"></div>';
                    }
                    
                    if (video && container) {
                        container.appendChild(video);
                        video.style.cssText = 'width: 100% !important; height: auto !important; display: block !important; border-radius: 12px;';
                    }
                    if (overlay && container) {
                        container.appendChild(overlay);
                        overlay.style.cssText = 'display: block !important; width: 100% !important; height: auto !important; position: absolute !important; top: 0 !important; left: 0 !important;';
                    }
                    
                    // Ocultar cualquier otro video o canvas fuera del contenedor
                    document.querySelectorAll('video').forEach(v => {
                        if (v.id !== 'webgazerVideoFeed') {
                            v.style.display = 'none !important';
                        }
                    });
                    document.querySelectorAll('canvas').forEach(c => {
                        if (c.id !== 'webgazerFaceOverlay') {
                            c.style.display = 'none !important';
                        }
                    });
                    
                    isWebGazerReady = true;
                    showMessage('Sistema listo para análisis en tiempo real.', 'success');
                    document.getElementById('currentState').textContent = 'Centro';
                    document.getElementById('accuracy').textContent = 'Mejorando...';
                }, 1500);
                
            } catch (error) {
                console.error('Error al inicializar WebGazer:', error);
                showMessage('Error al iniciar la cámara. Verifica los permisos.', 'error');
            }
        }

        // Detectar zona de la pantalla
        function detectZone(x, y) {
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            
            const normalizedX = x / screenWidth;
            const normalizedY = y / screenHeight;
            
            let horizontal = 'centro';
            let vertical = 'centro';
            
            if (normalizedX < SCREEN_ZONES.left_threshold) {
                horizontal = 'izquierda';
            } else if (normalizedX > SCREEN_ZONES.right_threshold) {
                horizontal = 'derecha';
            }
            
            if (normalizedY < SCREEN_ZONES.top_threshold) {
                vertical = 'arriba';
            } else if (normalizedY > SCREEN_ZONES.bottom_threshold) {
                vertical = 'abajo';
            }
            
            // Mapear a estados PNL
            if (vertical === 'arriba' && horizontal === 'izquierda') {
                return 'construc_visual';
            } else if (vertical === 'arriba' && horizontal === 'derecha') {
                return 'memoria_visual';
            } else if (vertical === 'centro' && horizontal === 'izquierda') {
                return 'construc_audio';
            } else if (vertical === 'centro' && horizontal === 'derecha') {
                return 'memoria_audio';
            } else if (vertical === 'abajo' && horizontal === 'izquierda') {
                return 'dialogo_interno';
            } else if (vertical === 'abajo' && horizontal === 'derecha') {
                return 'sensaciones';
            } else {
                return 'centro';
            }
        }

        // Actualizar estado PNL
        function updatePNLState(newState) {
            if (newState === currentState) return;
            
            currentState = newState;
            
            // Remover clase active de todos
            document.querySelectorAll('.pnl-box').forEach(box => {
                box.classList.remove('active');
            });
            
            // Agregar clase active al actual
            const activeBox = document.querySelector(`.pnl-box[data-state="${newState}"]`);
            if (activeBox) {
                activeBox.classList.add('active');
            }
            
            // Actualizar texto
            const stateNames = {
                'construc_visual': 'Construcción Visual',
                'memoria_visual': 'Memoria Visual',
                'construc_audio': 'Construcción Auditiva',
                'memoria_audio': 'Memoria Auditiva',
                'dialogo_interno': 'Diálogo Interno',
                'sensaciones': 'Sensaciones',
                'centro': 'Centro'
            };
            
            const stateDirections = {
                'construc_visual': 'Arriba-Izquierda',
                'memoria_visual': 'Arriba-Derecha',
                'construc_audio': 'Izquierda',
                'memoria_audio': 'Derecha',
                'dialogo_interno': 'Abajo-Izquierda',
                'sensaciones': 'Abajo-Derecha',
                'centro': 'Centro'
            };
            
            document.getElementById('currentState').textContent = stateNames[newState] || 'Centro';
            document.getElementById('gazeDirection').textContent = stateDirections[newState] || 'Centro';
        }

        // Actualizar punto de mirada (restringido al contenedor del video)
        function updateGazeDot(x, y) {
            const dot = document.getElementById('gazeDot');
            const container = document.getElementById('webcam-container');
            
            if (!showGazeDot || !container) return;
            
            // Obtener posición y dimensiones del contenedor
            const rect = container.getBoundingClientRect();
            
            // Convertir coordenadas globales a relativas del contenedor
            let relX = x - rect.left;
            let relY = y - rect.top;
            
            // Restringir coordenadas dentro del contenedor
            relX = Math.max(0, Math.min(relX, rect.width));
            relY = Math.max(0, Math.min(relY, rect.height));
            
            // Actualizar posición del punto
            dot.style.display = 'block';
            dot.style.left = relX + 'px';
            dot.style.top = relY + 'px';
        }

        // Toggle punto de mirada
        function toggleGazeDot() {
            showGazeDot = !showGazeDot;
            const dot = document.getElementById('gazeDot');
            dot.style.display = showGazeDot ? 'block' : 'none';
            showMessage(showGazeDot ? 'Punto de mirada visible' : 'Punto de mirada oculto', 'info');
        }

        // Iniciar calibración
        function startCalibration() {
            showMessage('Haz clic en diferentes puntos de la pantalla para calibrar', 'info');
            document.getElementById('accuracy').textContent = 'Calibrando...';
        }

        // Mostrar mensajes
        function showMessage(text, type) {
            const messageEl = document.getElementById('statusMessage');
            messageEl.textContent = text;
            messageEl.className = `status-message active ${type}`;
            
            if (type !== 'info') {
                setTimeout(() => {
                    messageEl.classList.remove('active');
                }, 5000);
            } else {
                setTimeout(() => {
                    messageEl.classList.remove('active');
                }, 3000);
            }
        }

        // Guardar datos de análisis en el backend
        async function saveAnalysisData() {
            if (gazeHistory.length < 10) return;
            
            try {
                await fetch('/api/save_gaze_data', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        timestamp: Date.now(),
                        state: currentState,
                        gazePoints: gazeHistory.slice(-50)
                    })
                });
            } catch (error) {
                console.error('Error guardando datos:', error);
            }
        }

        // Guardar datos cada 5 segundos
        setInterval(saveAnalysisData, 5000);

        // Verificar y ocultar elementos duplicados de WebGazer cada segundo
        setInterval(() => {
            document.querySelectorAll('video').forEach(v => {
                if (v.id !== 'webgazerVideoFeed') {
                    v.style.display = 'none !important';
                }
            });
            document.querySelectorAll('canvas').forEach(c => {
                if (c.id !== 'webgazerFaceOverlay') {
                    c.style.display = 'none !important';
                }
            });
        }, 1000);

        // Mejorar precisión con clics del usuario
        document.addEventListener('click', function(event) {
            if (isWebGazerReady) {
                // WebGazer usa los clics para calibrar automáticamente
                const accuracy = Math.min(100, gazeHistory.length * 2);
                document.getElementById('accuracy').textContent = accuracy + '%';
            }
        });

        // Inicializar al cargar
        window.addEventListener('load', function() {
            initWebGazer();
        });

        // Cleanup al salir
        window.addEventListener('beforeunload', function() {
            if (webgazer) {
                webgazer.end();
            }
        });
    </script>
</body>
</html>
